<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smapifan Quiz</title>
<style>
body {font-family: Arial; background:#101820; color:#fff; text-align:center; margin:0; padding:0;}
.container {margin-top:10vh;}
button {background:#ff4747; border:none; color:white; padding:12px 25px; margin:8px; border-radius:8px; cursor:pointer; font-size:1.1em; transition:0.2s;}
button:hover {background:#ff6767;}
input {display:block; margin:8px auto; padding:10px; border-radius:6px; border:none; width:200px; text-align:center;}
#options button{display:block; width:60%; margin:6px auto;}
#timer{margin-top:20px; font-size:1.3em;}
</style>
</head>
<body>
<div class="container" id="mainMenu">
  <h1>üéÆ Smapifan Quiz</h1>
  <button id="createGameBtn">Spiel erstellen</button>
  <button id="joinGameBtn">Spiel beitreten</button>
</div>

<div class="container" id="joinMenu" style="display:none;">
  <h2>Spiel beitreten</h2>
  <input id="joinCode" placeholder="Spielcode">
  <input id="username" placeholder="Spielername">
  <button id="joinConfirm">Beitreten</button>
  <button onclick="goBack()">Zur√ºck</button>
</div>

<div class="container" id="quizSelect" style="display:none;">
  <h2>W√§hle ein Quiz</h2>
  <div id="quizList"></div>
  <button onclick="goBack()">Zur√ºck</button>
</div>

<div class="container" id="gameArea" style="display:none;">
  <h2 id="questionText"></h2>
  <div id="options"></div>
  <div id="timer">‚è≥ 30s</div>
</div>

<div class="container" id="resultsArea" style="display:none;">
  <h2>üèÜ Ergebnis</h2>
  <div id="podium"></div>
</div>

<script>
const API_BASE = "/api/api.js";
let currentQuiz=null, questions=[], currentQuestionIndex=0, timerInterval;
let gameCode=null, username=null, isHost=false, joinedPlayers=[];

// ------------------ Create Game ------------------
document.getElementById("createGameBtn").onclick = async () => {
  const quizId = prompt("Welches Quiz starten? z.B. math_basic");
  const customCode = prompt("Benutzerdefinierter Spielcode:");
  if(!quizId||!customCode) return alert("Bitte Quiz und Code eingeben");
  const res = await fetch(API_BASE,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"createGame", quizId, code:customCode})
  });
  const data = await res.json();
  if(!data.success) return alert("Code bereits vorhanden!");
  gameCode = customCode;
  isHost = true;
  showJoiningScreen();
};

// ------------------ Join Game ------------------
document.getElementById("joinGameBtn").onclick = ()=>{
  document.getElementById("mainMenu").style.display="none";
  document.getElementById("joinMenu").style.display="block";
};
document.getElementById("joinConfirm").onclick = async ()=>{
  gameCode = document.getElementById("joinCode").value.trim();
  username = document.getElementById("username").value.trim();
  if(!gameCode||!username) return alert("Bitte Code + Name");
  const res = await fetch(API_BASE,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"joinGame", code:gameCode, username})
  });
  const data = await res.json();
  if(!data.success) return alert("Ung√ºltiger Code");
  isHost = false;
  showJoiningScreen();
};

// ------------------ Joining Screen ------------------
function showJoiningScreen(){
  document.querySelectorAll(".container").forEach(c=>c.style.display="none");
  let joinScreen=document.getElementById("joiningScreen");
  if(!joinScreen){
    joinScreen=document.createElement("div");
    joinScreen.className="container";
    joinScreen.id="joiningScreen";
    joinScreen.innerHTML=`<h2>Spielcode: ${gameCode}</h2>
      <div id="playerList"></div>
      ${isHost?'<button id="startQuizBtn">Quiz starten</button>':''}
      <button onclick="goBack()">Zur√ºck</button>`;
    document.body.appendChild(joinScreen);
  }
  joinScreen.style.display="block";
  updatePlayerList();
  if(isHost){
    document.getElementById("startQuizBtn").onclick = async ()=>{
      await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"startGame",code:gameCode})});
      loadQuizzes();
    };
  }
  if(!isHost){setInterval(updatePlayerList,2000);}
}

// ------------------ Update Players ------------------
async function updatePlayerList(){
  const res = await fetch(`${API_BASE}?action=getPlayers&code=${gameCode}`);
  const data = await res.json();
  joinedPlayers = data.players||[];
  const listDiv=document.getElementById("playerList");
  listDiv.innerHTML="";
  joinedPlayers.forEach(p=>{const el=document.createElement("div");el.textContent=p.username;listDiv.appendChild(el);});
}

// ------------------ Quiz laden ------------------
async function loadQuizzes(){
  const res = await fetch("data/quizzes.json");
  const quizzes = await res.json();
  const quizList=document.getElementById("quizList");
  quizList.innerHTML="";
  quizzes.forEach(q=>{
    const btn=document.createElement("button");
    btn.textContent=q.title;
    btn.style.background=q.color;
    btn.onclick=()=>startGame(q.id);
    quizList.appendChild(btn);
  });
  document.getElementById("quizSelect").style.display="block";
}

// ------------------ Quiz starten ------------------
async function startGame(quizId){
  const allQuestions = await (await fetch("data/questions.json")).json();
  const quiz = (await (await fetch("data/quizzes.json")).json()).find(q=>q.id===quizId);
  questions = allQuestions[quiz.questions_key];
  currentQuiz=quiz;
  currentQuestionIndex=0;
  document.getElementById("quizSelect").style.display="none";
  document.getElementById("gameArea").style.display="block";
  showQuestion();
}

// ------------------ Frage anzeigen ------------------
function showQuestion(){
  const q = questions[currentQuestionIndex];
  if(!q) return showResults();
  document.getElementById("questionText").textContent=q.question;
  const options=document.getElementById("options");
  options.innerHTML="";
  q.options.forEach(opt=>{
    const btn=document.createElement("button");
    btn.textContent=opt;
    btn.onclick=()=>answer(opt===q.correct);
    options.appendChild(btn);
  });
  startTimer();
}

// ------------------ Timer ------------------
function startTimer(){
  let time=currentQuiz.time_per_question;
  document.getElementById("timer").textContent=`‚è≥ ${time}s`;
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    time--;
    document.getElementById("timer").textContent=`‚è≥ ${time}s`;
    if(time<=0){clearInterval(timerInterval); answer(false);}
  },1000);
}

// ------------------ Antwort absenden ------------------
async function answer(correct){
  clearInterval(timerInterval);
  await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"submitAnswer",code:gameCode,username,correct})});
  currentQuestionIndex++;
  setTimeout(showQuestion,500);
}

// ------------------ Ergebnisse ------------------
async function showResults(){
  document.getElementById("gameArea").style.display="none";
  document.getElementById("resultsArea").style.display="block";
  const res = await fetch(`${API_BASE}?action=getResults&code=${gameCode}`);
  const data = await res.json();
  const podium = document.getElementById("podium");
  podium.innerHTML="";
  data.results.slice(0,5).forEach((p,i)=>{
    const el=document.createElement("div");
    el.textContent=`${i+1}. ${p.username} - ${p.points} Punkte`;
    podium.appendChild(el);
  });
}

// ------------------ Zur√ºck ------------------
function goBack(){
  document.querySelectorAll(".container").forEach(c=>c.style.display="none");
  document.getElementById("mainMenu").style.display="block";
}
</script>
</body>
</html>
