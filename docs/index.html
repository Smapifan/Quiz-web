<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Game</title>
<style>
  body{font-family:sans-serif;background:#f0f0f0;margin:0;padding:0}
  .container{max-width:800px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
  h1,h2,h3{margin:10px 0;text-align:center}
  button{padding:10px 20px;margin:5px;cursor:pointer;border:none;border-radius:5px}
  input{padding:10px;margin:5px;width:calc(100% - 22px)}
  .player-list{margin:10px 0}
  .question{margin:20px 0;text-align:center;font-size:1.2em}
  .options{display:flex;flex-wrap:wrap;justify-content:center}
  .option{padding:10px 20px;margin:5px;background:#ddd;border-radius:5px;cursor:pointer}
  .timer{font-size:1.5em;text-align:center;margin:10px 0}
  .hidden{display:none}
  .podest{display:flex;justify-content:center;margin:20px 0}
  .podest div{padding:10px 20px;margin:5px;background:#ffd700;border-radius:5px;text-align:center;}
</style>
</head>
<body>
<div class="container">
  <h1>Quiz Game</h1>

  <div id="start-screen">
    <button id="create-btn">Create Game</button>
    <button id="join-btn">Join Game</button>
  </div>

  <div id="create-game" class="hidden">
    <h2>Quiz erstellen</h2>
    <select id="quiz-select"></select>
    <button id="create-game-btn">Spiel erstellen</button>
    <p id="game-code-display"></p>
    <h3>Gejoint Spieler:</h3>
    <div id="player-list" class="player-list"></div>
    <button id="start-quiz-btn">Quiz starten</button>
  </div>

  <div id="join-game" class="hidden">
    <h2>Spiel beitreten</h2>
    <input type="text" id="join-code" placeholder="Spielcode">
    <input type="text" id="join-username" placeholder="Dein Name">
    <button id="join-game-btn">Beitreten</button>
    <h3>Gejoint Spieler:</h3>
    <div id="join-player-list" class="player-list"></div>
  </div>

  <div id="quiz-screen" class="hidden">
    <div class="timer" id="timer">30</div>
    <div class="question" id="question-text"></div>
    <div class="options" id="options-container"></div>
  </div>

  <div id="result-screen" class="hidden">
    <h2>Endergebnis</h2>
    <div id="podest" class="podest"></div>
  </div>

</div>

<script>
let quizzes = [];
let questions = {};
let gameCode = '';
let currentQuiz = '';
let currentQuestionIndex = 0;
let timerInterval;
let timeLeft = 30;
let isHost = false;
let username = '';
let players = [];

async function loadData(){
  quizzes = await fetch('data/quizzes.json').then(r=>r.json());
  questions = await fetch('data/questions.json').then(r=>r.json());

  const quizSelect = document.getElementById('quiz-select');
  quizzes.forEach(q=>{
    const opt = document.createElement('option');
    opt.value=q.id;
    opt.textContent=q.title;
    quizSelect.appendChild(opt);
  });
}

// -------- Utility: API Call --------
async function api(action,data={}){
  const params = {...data, action};
  const res = await fetch('api/api.js', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(params)
  });
  return res.json();
}

// -------- Create Game --------
document.getElementById('create-btn').onclick = ()=>{
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('create-game').classList.remove('hidden');
  isHost = true;
}

// -------- Join Game --------
document.getElementById('join-btn').onclick = ()=>{
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('join-game').classList.remove('hidden');
  isHost = false;
}

// -------- Create Game Button --------
document.getElementById('create-game-btn').onclick = async ()=>{
  const quizId = document.getElementById('quiz-select').value;
  currentQuiz = quizId;
  gameCode = Math.floor(Math.random()*90000+10000).toString();
  const res = await api('createGame',{quizId, code:gameCode});
  if(res.success){
    document.getElementById('game-code-display').textContent = 'Spielcode: '+gameCode;
    updatePlayers();
    setInterval(updatePlayers,2000);
  }else{
    alert(res.error);
  }
}

// -------- Join Game Button --------
document.getElementById('join-game-btn').onclick = async ()=>{
  gameCode = document.getElementById('join-code').value.trim();
  username = document.getElementById('join-username').value.trim();
  if(!gameCode || !username) return alert('Code und Name eingeben');
  const res = await api('joinGame',{code:gameCode, username});
  if(res.success){
    document.getElementById('join-game').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    loadQuestion();
    setInterval(loadQuestion,1000);
  }else{
    alert(res.error);
  }
}

// -------- Update Players List (Host) --------
async function updatePlayers(){
  if(!isHost) return;
  const res = await api('getPlayers',{code:gameCode});
  players = res.players;
  const list = document.getElementById('player-list');
  list.innerHTML='';
  players.forEach(p=>{
    const div = document.createElement('div');
    div.textContent = p.username;
    list.appendChild(div);
  });
}

// -------- Start Quiz (Host) --------
document.getElementById('start-quiz-btn').onclick = async ()=>{
  await api('startGame',{code:gameCode});
  document.getElementById('create-game').classList.add('hidden');
  document.getElementById('quiz-screen').classList.remove('hidden');
  loadQuestion();
}

// -------- Load Question --------
async function loadQuestion(){
  const quizQuestions = questions[currentQuiz];
  if(currentQuestionIndex >= quizQuestions.length){
    showResults();
    return;
  }
  const q = quizQuestions[currentQuestionIndex];
  document.getElementById('question-text').textContent = q.question;
  const optionsDiv = document.getElementById('options-container');
  optionsDiv.innerHTML='';
  q.options.forEach(opt=>{
    const btn = document.createElement('div');
    btn.classList.add('option');
    btn.textContent = opt;
    btn.onclick = ()=>submitAnswer(opt===q.correct);
    optionsDiv.appendChild(btn);
  });
  startTimer();
}

// -------- Timer --------
function startTimer(){
  clearInterval(timerInterval);
  timeLeft = 30;
  document.getElementById('timer').textContent = timeLeft;
  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').textContent = timeLeft;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      currentQuestionIndex++;
      loadQuestion();
    }
  },1000);
}

// -------- Submit Answer --------
async function submitAnswer(correct){
  if(!username) return;
  await api('submitAnswer',{code:gameCode, username, correct, currentQuestionIndex});
  clearInterval(timerInterval);
  currentQuestionIndex++;
  loadQuestion();
}

// -------- Show Results --------
async function showResults(){
  document.getElementById('quiz-screen').classList.add('hidden');
  const res = await api('getResults',{code:gameCode});
  const podest = document.getElementById('podest');
  podest.innerHTML='';
  res.results.slice(0,3).forEach((p,i)=>{
    const div = document.createElement('div');
    div.textContent = `${i+1}. ${p.username}: ${p.points} Punkte`;
    podest.appendChild(div);
  });
  document.getElementById('result-screen').classList.remove('hidden');
}

loadData();
</script>
</body>
</html>
